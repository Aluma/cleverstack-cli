#!/usr/bin/env node

var program = require( 'commander' )
  , semver  = require( 'semver' )
  , path    = require( 'path' )
  , fs      = require( 'fs' )
  , git     = require( 'simple-git' )()
  , lib     = require( path.join( __dirname, '..', 'index' ) );

program.version( lib.pkg.version )
  .usage( '-p <path> [options] <project> [backend|frontend]' )
  .option( '-v, --versions [versions]', 'Install a specific package version.' )
  .option( '-p, --path <path>', 'Path to install the package to.' );

program.on( '--help', function ( ) {
  console.log( '  Examples:' );
  console.log( '    clever init my-project' );
  console.log( '    clever init my-project-frontend frontend' );
  console.log( '    clever init my-project-backend backend' );
  console.log( '' );
} );

program.parse( process.argv );

if (!program.path) {
  program.help( );
}

var module = program.args[0]
  , git    = require( 'simple-git' )( program.path );

function end( err ) {
  if (!!err) {
    return lib.utils.fail( err );
    process.exit( 1 );
  }

  process.exit( 0 );
}

function checkOut( err ) {
  if (!!err) {
    return lib.utils.fail( err );
  }

  var _git = require( 'simple-git' )( program.path );

  if (!program.versions) {
    _git.checkout( 'master', end );
  } else {
    _git._run( 'git checkout -B ' + program.versions +  ' tags/v' + program.versions, end );
  }
}

if (fs.existsSync( path.resolve( path.join( program.path, '.git' ) ) )) {
  checkOut();
} else {
  if (module.indexOf( '/' ) === -1) {
    module = 'clevertech/' + module;
  }

  git._run('git clone https://github.com/' + module + '.git ' + program.path, checkOut );
}
