#!/usr/bin/env node

var Promise = require( 'bluebird' )
  , program = require( 'commander' )
  , path    = require( 'path' )
  , mkdirp  = require( 'mkdirp' )
  , spawn   = require( 'win-spawn' )
  , fs      = require( 'fs' )
  , rimraf  = require( 'rimraf' )
  , async   = require( 'async' )
  , lib     = require( path.join( __dirname, '..', 'index' ) );

Promise.longStackTraces( );

program
  .version( lib.pkg.version )
  .option( '-v, --versions', 'Select a specific cleverstack version that you want initialize with.')
  .option( '-f, --fetch', 'Installs the package without cloning the git repo.');

program
  .command( '<project>' )
  .description( ' Creates a project named <project>' );

program.on( '--help', function ( ) {
  console.log( '  Examples:' );
  console.log( '    clever init my-project' );
  console.log( '    clever init project-frontend frontend' );
  console.log( '    clever init my-project-everything backend frontend' );
  console.log( '    clever init --fetch my-project-frontend frontend' );
  console.log( '    clever init --fetch my-project-backend backend' );
  console.log( '' );
} );

program.parse( process.argv );

var project = program.args[0]
  , args    = program.args.slice( 1 );

if (args.length < 1 || (args.indexOf( 'backend' ) === -1 && args.indexOf( 'frontend' ))) {
  args.push( 'backend' );
  args.push( 'frontend' );
}

var remotes = {
  backend:  'cleverstack-node-seed',
  frontend: 'cleverstack-angular-seed'
}

if (!project || project.toString( ).trim( ) === "") {
  program.help( );
}

var projectFolder = path.join( process.cwd( ), project );

if (fs.existsSync( projectFolder )) {
  lib.utils.fail( "Can't create project " + project + " due to a folder named " + project + " existing in " + process.cwd() );
}

var installArgs = [];
if (program.versions) {
  installArgs.push( '-v' );
  installArgs.push( program.versions );
}

if (program.fetch) {
  installArgs.push( '-f' );
}

function installDeps ( projectDir ) {
  return new Promise( function ( res, rej ) {
    var pkg = require( path.join( projectDir, 'package.json' ) );

    if (!pkg.hasOwnProperty( 'bundledDependencies' ) || pkg.bundledDependencies.length < 1) {
      return res( );
    }

    lib.utils.info( 'Installing bundled dependencies...' );
    lib.project.installBundledModules( projectDir, pkg.bundledDependencies ).then( function ( ) {
      res( );
    } )
    .catch( rej );
  } );
}

function setupBackend ( ) {
  var def         = Promise.defer( )
    , projectDir  = path.join( projectFolder, 'backend' );

  if (args.indexOf( 'backend' ) !== -1) {
    mkdirp( projectDir, function ( err ) {
      if (!!err) {
        return def.reject( err );
      }

      var proc = spawn( path.join( __dirname, ( 'clever-install' + ( !program.fetch ? '-git' : '-fetch' ) ) ), [remotes.backend, '-p', projectDir].concat( installArgs ), {stdio: 'inherit'} );
      proc.on( 'close', function ( code ) {
        if (code !== 0) {
          return def.reject( );
        }

        installDeps( projectDir )
        .then( function ( ) {
          def.resolve( );
        } )
        .catch( function ( err ) {
          def.reject( err );
        } );
      } );
    } );
  } else {
    process.nextTick( function( ) {
      return def.resolve( );
    } );
  }

  return def.promise;
}

function setupFrontend( ) {
  var def = Promise.defer( );

  if (args.indexOf( 'frontend' ) !== -1) {
    mkdirp( path.resolve( path.join( projectFolder, 'frontend' ) ), function ( err ) {
      if (!!err) {
        return def.reject( err );
      }

      var proc = spawn( path.join( __dirname, ( 'clever-install' + ( !program.fetch ? '-git' : '-fetch' ) ) ), [remotes.frontend, '-p', projectFolder + path.sep + 'frontend'].concat( installArgs ), {stdio: 'inherit'} );
      proc.on( 'close', function ( code ) {
        if (code !== 0) {
          return def.reject( );
        }

        def.resolve( );
      } );
    } );
  } else {
    process.nextTick( function( ) {
      return def.resolve( );
    } );
  }

  return def.promise;
}

function setupModules( modules ) {
  var def = Promise.defer( );

  async.eachSeries( fs.readdirSync( path.resolve( path.join( projectFolder ) ) ), function ( p, fn ) {
    var _path = path.resolve( path.join( projectFolder, p ) );

    process.chdir( _path );
    var proc = spawn( path.join( __dirname, 'clever-install' ), modules, { cwd: _path, stdio: 'inherit' } );

    proc.on( 'close', function ( ) {
      fn( );
    } );

  }, function ( err ) {
    if (!!err) {
      return def.reject( err );
    }

    def.resolve( );
  } );

  return def.promise;
}

function setupPackages( ) {
  var def = Promise.defer( );

  async.eachSeries( fs.readdirSync( path.resolve( path.join( projectFolder ) ) ), function ( p, fn ) {
    var _path = path.resolve( path.join( projectFolder, p ) );

    process.chdir( _path );

    lib.utils.info( 'Installing NPM packages for ' + _path );
    var proc = spawn( 'npm', ['install'] )
      , err = '';

    proc.stderr.on('data', function ( data ) {
      err += data + '';
    } );

    proc.on( 'close', function ( code ) {
      if (code !== 0) {
        return fn( err );
      }

      lib.utils.success( 'Finished installing NPM packages for ' + _path );

      var modulesFolder = path.resolve( path.join( projectFolder, p, 'modules' ) )
        , modules = [];

      if (fs.existsSync( modulesFolder )) {
        modules = fs.readdirSync( modulesFolder );
        lib.utils.warn( 'Installing module NPMs for ' + _path );
      }

      async.eachSeries( modules, function ( m, next ) {
        lib.project.installModule( {
          moduleDir: modulesFolder,
          modulePath: ''
        }, path.resolve( path.join( modulesFolder, m ) ) )
        .then( function ( ) {
          next( );
        } )
        .catch( function ( err ) {
          next( err );
        } );
      },
      function ( err ) {
        if (!!err) {
          return fn( err );
        }

        if (modules.length > 0) {
          lib.utils.success( 'Finished installing module NPMs' );
        }

        var bowerPath = path.resolve( path.join( projectFolder, p, 'bower.json' ) );
        process.chdir( path.resolve( path.join( projectFolder, p ) ) );

        // backend folder?
        if (!fs.existsSync( bowerPath ) ) {
          return fn( );
          // lib.utils.warn( 'Running database migrations...' );

          // var args = [ '--base', path.resolve( path.join( projectFolder, p ) ), '--gruntfile', path.resolve( path.join( projectFolder, p, 'Gruntfile.js' ) ), 'db' ]
          //   , err  = '';

          // var env       = process.env;
          // env.NODE_ENV  = 'local'; // overwriting is necessary...

          // var proc = spawn( 'grunt', args, {stdio: 'inherit', env: env} );

          // proc.on( 'close', function ( code ) {
          //   if (code !== 0) {
          //     return fn( err );
          //   }

          //   process.chdir( path.join( process.cwd( ) , '..' ) );
          //   fn( );
          // } );
        } else {
          lib.utils.info( 'Installing bower packages for ' + _path);

          var err  = ''
            , proc = spawn( 'npm', ['run', 'setup'] );

          proc.stderr.on('data', function ( data ) {
            err += data + '';
          } );

          proc.on( 'close', function ( code ) {
            if (code !== 0) {
              return fn( err );
            }

            lib.utils.success( 'Finished installing bower packages.' );
            fn( );
          } );
        }
      } );
    } );
  },
  function ( err ) {
    if (!!err) {
      return def.reject( err );
    }

    def.resolve( );
  } );

  return def.promise;
}

Promise.all( args )
.then( function ( modules ) {
  var def = Promise.defer( );

  lib.utils.info( 'Creating ' + project + ' folder in ' + process.cwd( ) + '...' );
  mkdirp( projectFolder, function ( err ) {
    if (!!err) {
      return def.reject( err );
    }

    def.resolve( modules );
  } );

  return def.promise;
} )
.then( function ( modules ) {
  lib.utils.info( 'Fetching repositories... ' );
  return setupBackend( );
} )
.then( function( ) {
  return setupFrontend( );
} )
.then( function( ) {
  var def = Promise.defer( );

  // we no longer need backend/frontend
  var filters = ['clever-backend', 'clever-frontend', 'backend', 'frontend'];
  filters.forEach( function ( filter ) {
    var find = args.indexOf( filter );
    if (find > -1) {
      args.splice( find, 1 );
    }
  } );

  if (args.length < 1 ) {
    process.nextTick( function ( ) {
      def.resolve( );
    } );
  } else {
    lib.utils.info( 'Installing additional modules...' );

    setupModules( args ).then( function ( ) {
      def.resolve( );
    }, function ( err ) {
      def.reject( err );
    } );
  }

  return def.promise;
} )
.then( function( ) {
  lib.utils.info( 'Installing necessary packages...' );
  return setupPackages( );
} )
.then( function( ) {
  lib.utils.success( 'Project ' + project + ' has been created in ' + projectFolder );
  process.exit( 0 );
} )
.catch( function ( err ) {
  lib.utils.fail( err );

  // remove the project folder if we failed...
  rimraf( projectFolder, function ( err ) {
    if (!!err) {
      console.error( err );
    }

    process.exit( 1 );
  } );
} )
